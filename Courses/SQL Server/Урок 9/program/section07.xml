<?xml version="1.0" encoding="windows-1251" ?>

<!DOCTYPE page [
<!ENTITY nbsp "&#160;">
<!ENTITY пробел "&#160;">
<!ENTITY shy "&#173;">
<!ENTITY перенос "&#173;">
]>

<?xml:stylesheet type="text/xsl" href="../common/layout.xsl" ?>

<Урок xmlns="x-schema:Schema.xml" название="Восстановление из резервных копий."  предыдущий="section06.xml" следующий="section08.xml" copyright="© 2005 Вадим Волянский, Алексей Туманов.">

<h1 style="color:maroon">Восстановление из резервных копий.</h1>

<p>После всех проверок пора бы и к восстановлению приступить.</p>

<h3 style="color:#05027E;text-align:center">Полное восстановление базы данных.</h3>

<p>Произвести восстановление позволяет команда <b>RESTORE DATABASE</b>.</p>

<pre style="border-color:#FF0000">

<b>RESTORE DATABASE</b>

	{ имя_базы_данных | @имя_переменной_хранящей_имя_базы_данных } 

	[ FROM имя_устройства_резервного_копирования1,

	имя_устройства_резервного_копирования2,

	...

	имя_устройства_резервного_копированияN

	[ WITH 

	[ RESTRICTED_USER ] 

	[ [ , ] FILE = {номер_файла_из_набора | @имя_переменной_хранящей_номер_файла_из_набора } ] 

	[ [ , ] PASSWORD = { пароль_на_набор_резервных_копий | @имя_переменной_хранящей_пароль } ] 

	[ [ , ] MEDIANAME = { описательное_имя | @имя_переменной_хранящей_описательное_имя } ] 

	[ [ , ] MEDIAPASSWORD = { 'пароль_на_восстановление' | @имя_переменной_хранящей_пароль_на_восстановление } ] 

	[ [ , ] MOVE 'логическое_имя_файла' TO 'физическое_имя_файла' ] 

	[ ,...n ] 

	[ [ , ] KEEP_REPLICATION ] 

	[ [ , ] { NORECOVERY | RECOVERY | STANDBY = undo_file_name } ] 

	[ [ , ] { NOREWIND | REWIND } ] 

	[ [ , ] { NOUNLOAD | UNLOAD } ] 

	[ [ , ] REPLACE ] 

	[ [ , ] RESTART ] 

	[ [ , ] STATS [ = percentage ] ] 
	]

</pre>

<ol>
	<li><b><i>Имя_базы_данных</i></b> - имя базы данных, которая восстанавливается.</li>
	<li><b><i>Перечисление устройств резервного копирования</i></b> - определяется, откуда необходимо производить восстановление.</li>
	<li><b><i>RESTRICTED_USER</i></b> - определение доступа к файлам после восстановления. Указав эту опцию, к восстановленной базе данных будут иметь доступ только пользователи групп sysadmin, db_owner и db_creator.</li>
	<li><b><i>FILE</i></b> - этот параметр указывает на номер источника, откуда надо восстанавливать базу данных, если в файле находится несколько резервных копий.</li>
	<li><b><i>PASSWORD</i></b> - пароль, установленный на набор резервных копий.</li>
	<li><b><i>MEDIANAME</i></b> - описательное имя набора резервных копий. Если указанное имя не будет совпадать с тем, которое указывалось при создании, то восстановление производиться не будет.</li>
	<li><b><i>MEDIAPASSWORD</i></b> - пароль, указанный при создании резервной копии, установленный на резервную копию.</li>
	<li><b><i>MOVE...TO...</i></b> - позволяет изменить имя и месторасположение файлов, если восстановить базу данных нужно в другое место.</li>
	<li><b><i>KEEP_REPLICATION</i></b> - указывает, что настройки репликации останутся без изменений.</li>
	<li><b><i>RECOVERY</i></b> - эта опция указывается при восстановлении последнего журнала транзакций или после восстановления из полной резервной копии, для возвращения базы данных в рабочее состояние. При этом SQL Server произведет такие действия:
	<ul>
<li>Сервер SQL откатывает любые незавершенные транзакции в журнале транзакций и закрепляет завершенные транзакции.</li>
<li>База данных готова к использованию после окончания процесса восстановления.</li>
	</ul>
Она выставлена по умолчанию.
</li>

	<li><b><i>NORECOVERY</i></b> эту опцию нужно указывать, если есть несколько резервных копий для восстановления. Когда указывается эта опция, то SQL Server:
	<ul>
<li>Не откатывает незавершенные транзакции и не закрепляются завершенные.</li>
<li>База данных не доступна к использованию.</li>
	</ul>
</li>
	<li><b><i>STANDBY</i></b> - определяет имя и путь к файлу, в котором будет сохранена информация для отката процесса восстановления. Если перевести базу данных в режим STANDBY, то база данных будет недоступна к использованию.</li>
	<li><b><i>NOREWIND | REWIND</i></b> - перемотка магнитной ленты.</li>
	<li><b><i>NOUNLOAD | UNLOAD</i></b> - выбрасывание кассеты.</li>
	<li><b><i>REPLACE</i></b> - при указании этой опции, будет произведено замещение файлов существующей базы данных восстанавливаемыми.</li>
	<li><b><i>RESTART</i></b> - используется для того, чтобы продолжить прерванное восстановление.</li>
	<li><b><i>STATS</i></b> - проценты, определяющие шаг уведомления о прогрессе восстановления.</li>
</ol>

<p>Пример1. Сделаем восстановление базы данных books с перезаписью.</p>

<pre style="border-color:863900">

	RESTORE DATABASE books FROM mybackup WITH REPLACE

</pre>

<p>Пример2. Сделаем восстановление базы данных books с использованием файла отката, при этом восстановим ее на диск D.</p>

<pre style="border-color:863900">

	RESTORE DATABASE books FROM mybackup

	WITH MOVE 'books_dat' TO 'D:\books_recovered.mdf',

	STANDBY = 'D:\recovery_standby.dat',

	STATS = 10

</pre>

<p>Результат:</p>

<img src="img\pict8.jpg"></img>

<p>Учитывая, что база данных была переведена в режим STANDBY, использовать ее нельзя. В свою очередь Management Studio отображает ее как "Только для чтения". Также, вы должны понимать, что восстановленная база, с которой вы сможете в дальнейшем работать, находится уже на диске D:, логическое имя файла так и осталось books_dat, а физическое D:\books_recovered.mdf, независимо от старого месторасположения. При этом старый файл уничтожается.</p>

<p>
После этого необходимо вернуть базу данных в согласованное состояния. Для этого нужно сделать запрос, который выполнит из журнала транзакций все команды, которые были выполнены после создания резервной копии. Для этого используется команда <b>RESTORE LOG</b>. Этот процесс носит имя: <b>Восстановление по журналу транзакций.</b></p>

<h3 style="color:#05027E;text-align:center">Восстановление по журналу транзакций.</h3>

<pre style="border-color:#FF0000">

	RESTORE LOG { имя_базы_данных | @имя_переменной_хранящей_имя_базы_данных } 

	[FROM имя_устройства_резервного_копирования1,

	имя_устройства_резервного_копирования2,

	...

	имя_устройства_резервного_копированияN
	] 

	[ WITH 

	[ RESTRICTED_USER ] 

	[ [ , ] FILE = { номер_файла_из_набора | @имя_переменной_хранящей_номер_файла_из_набора } ] 

	[ [ , ] PASSWORD = { пароль_на_набор_резервных_копий | @имя_переменной_хранящей_пароль } ] 

	[ [ , ] MEDIANAME = { описательное_имя | @имя_переменной_хранящей_описательное_имя } ] 

	[ [ , ] MEDIAPASSWORD = { 'пароль_на_восстановление' | @имя_переменной_хранящей_пароль_на_восстановление } ]
 
	[ [ , ] KEEP_REPLICATION ] 

	[ [ , ] { NORECOVERY | RECOVERY | STANDBY = undo_file_name } ] 

	[ [ , ] { NOREWIND | REWIND } ] 

	[ [ , ] { NOUNLOAD | UNLOAD } ] 

	[ [ , ] RESTART ] 

	[ [ , ] STATS [= percentage ] ] 

	[ [ , ] STOPAT = { дата | @имя_переменной_хранящей_дату } 

	| [ , ] STOPATMARK = 'контрольная_точка_после_которой_производится_восстановление' [ AFTER дата ] 

	| [ , ] STOPBEFOREMARK = 'контрольная_точка_после_которой_производится_восстановление' [ AFTER дата ] 
	] 
]

</pre>

<p>Как видите, существует возможность указать SQL Server, какую часть журнала транзакций использовать. Для этого используются либо <b>Контрольные_точки</b>, либо дата. <b>Контрольная точка</b> - это имя произведенной транзакции.</p>

<p>Продолжим восстановление нашей базы данных books при помощи журнала транзакций.</p>

<pre style="border-color:863900">

	RESTORE LOG books FROM mybackup WITH RECOVERY

</pre>

<p>Результат:</p>

<img src="img\pict9.jpg"></img>

<p>При этом будет произведено удаление файла отката, т.к. он больше не нужен. После этой команды, база данных перейдет в рабочее состояние, т.к. указана опция RECOVERY.</p>

<p>Если у вас несколько файлов журнала транзакций, то запрос на восстановление будет иметь следующий вид:</p>

<pre style="border-color:863900">

	RESTORE DATABASE books FROM mybackup WITH NORECOVERY

	RESTORE LOG books FROM mybackup_log1 WITH FILE = 1, NORECOVERY

	RESTORE LOG books FROM mybackup_log1 WITH FILE = 2, RECOVERY

</pre>

<p>В последней строке восстановления указана опция RECOVERY!!!.</p>

<p>Пример восстановления по журналу транзакций до указанного времени, используя при этом два файла журнала транзакций.</p>

<pre style="border-color:863900">

	RESTORE DATABASE books FROM mybackup WITH NORECOVERY

	RESTORE LOG books FROM mybackup_log1 WITH FILE = 1, NORECOVERY

	RESTORE LOG books FROM mybackup_log1 WITH FILE = 2, RECOVERY, 

	[STOPAT =’7-1-2005 11.05.50 am’]

</pre>

<p><b>Для заполнения времени</b> можно использовать 2 варианта:</p>

<ol>
	<li>'7-1-2005 11.05.50 am'</li>
	<li>'jul 1, 2005 11.05.50 am'</li>
</ol>

<p>И еще один пример восстановления по журналу - восстановление до метки.</p>

<pre style="border-color:863900">
<pre>
	use books<span style="color:#008080">-- устанавливаем текущую базу данных.</span>

	begin transaction tr1<span style="color:#008080">-- начинаем транзакцию с именем tr1.</span>

	insert into books (code,new,name,date,id_press,id_category,id_theme)

	values (3465,1,'колобок','10-27-2005 15:48:00',1,1,1)

	commit transaction tr1<span style="color:#008080">-- завершаем транзакцию. Сохраняем контрольную точку в журнале.</span>
</pre>
<pre>
	begin transaction tr2

	insert into books (code,new,name,date,id_press,id_category,id_theme)

	values (3467,1,'курочка ряба','10-27-2005 16:07:00',1,2,3)

	commit transaction tr2
</pre>
<pre>

	BACKUP LOG books TO mybackup_log1<span style="color:#008080">-- создаем резервную копию журнала транзакций.</span>

</pre>

<pre>

	RESTORE DATABASE books FROM mybackup WITH NORECOVERY<span style="color:#008080">-- восстанавливаем базу данных.</span>

	RESTORE LOG books FROM mybackup_log1 WITH FILE = 1, NORECOVERY<span style="color:#008080">/* восстанавливаем базу
данных, при помощи первого журнала транзакций (был сохранен ранее).*/</span>

	RESTORE LOG books FROM mybackup_log1 WITH FILE = 2, RECOVERY, 

	[STOPATMARK = 'tr2']<span style="color:#008080">/* довосстанавливаем базу данных, при помощи второго журнала 
транзакций до метки tr2 и устанавливаем базу данных в согласованное состояние.*/</span>

</pre>

</pre>

<p><b>ВНИМАНИЕ!!!</b> Нельзя указывать опцию STOPAT вместе с опциями NORECOVER либо STANDBY.</p>

<p><b>Это один из примеров восстановления из дифференцированной резервной копии.</b></p>

<p>Производить восстановление из дифференцированной резервной копии можно только после произведения полного восстановления базы данных.</p>

<h3 style="color:#05027E;text-align:center">Восстановление файлов и групп файлов.</h3>

<p>И еще один вариант восстановления данных. Этот способ нужен в том случае, если, например, случайно был удален определенный файл. Делать полное восстановление нет смысла, а вот восстановить отдельный файл и быстрее и менее хлопотно.</p>

<p>При этом способе восстановления, вы должны помнить также о том, что нужно применять все журналы транзакций в порядке создания, чтобы восстановить файловую группу, либо файл в полное состояние.</p>

<pre style="border-color:#FF0000">
<b>RESTORE DATABASE</b>

	{ имя_базы_данных | @имя_переменной_хранящей_имя_базы_данных } 

	Имя_файла_либо_группы_файлов1, 

	Имя_файла_либо_группы_файлов2,

	...

	Имя_файла_либо_группы_файловN

	[ FROM имя_устройства_резервного_копирования1,

	имя_устройства_резервного_копирования2,

	...

	имя_устройства_резервного_копированияN]

	[ WITH 

	[ RESTRICTED_USER ]

	[ [ , ] FILE = {номер_файла_из_набора | @имя_переменной_хранящей_номер_файла_из_набора } ] 

	[ [ , ] PASSWORD = { пароль_на_набор_резервных_копий | @имя_переменной_хранящей_пароль } ] 

	[ [ , ] MEDIANAME = { описательное_имя | @имя_переменной_хранящей_описательное_имя } ] 

	[ [ , ] MEDIAPASSWORD = { 'пароль_на_восстановление' | @имя_переменной_хранящей_пароль_на_восстановление } ] 

	[ [ , ] MOVE 'логическое_имя_файла' TO 'физическое_имя_файла' ] 

	[ [ , ] { NORECOVERY } ] 

	[ [ , ] { NOREWIND | REWIND } ] 

	[ [ , ] { NOUNLOAD | UNLOAD } ] 

	[ [ , ] REPLACE ]

	[ [ , ] RESTART ] 

	[ [ , ] STATS [ = percentage ] ] 
	]
</pre>

<p>Должно быть вы заметили, что все отличие от полного восстановления состоит в том, что здесь еще указываются те файлы, которые необходимо восстановить из устройства резервного копирования.</p>

<p>Пример. Предположим, что база данных books состоит из двух основных файлов. Один файл называется books_dat, а второй books_dat2. Второй файл необходимо восстановить.</p>

<pre style="border-color:863900">

<pre>
	RESTORE DATABASE books FILE='books_dat2'

	FROM mybackup WITH NORECOVERY<span style="color:#008080">/* Восстанавливаем файл books_dat2.*/</span>
</pre>
<pre>

	RESTORE LOG books FROM mybackup WITH RECOVERY <span style="color:#008080">/*Восстановление по журналу транзакций.*/</span>

</pre>
</pre>

<h3 style="color:#05027E;text-align:center">Восстановление базы данных при помощи Management Studio.</h3>

<p>Чтобы произвести восстановление при помощи Management Studio, необходимо выбрать подпункт контекстного меню Restore Database, пункта Все задачи к папке Databases.</p>

<img src="img\pict10.jpg"></img>

<p>После этого на экране появится окно, определяющее опции восстановления.</p>

<img src="img\pict11.jpg"></img>

<p>Данные, которые отображаются в этом окне, SQL Server берет из таблицы msdb.</p>



<p>Чтобы восстановить данные с определенного устройства нужно выбрать From device.</p>



<p>Для указания устройства резервного копирования нужно нажать на кнопку с тремя точками после выбора пункта From Device.</p>

<img src="img\pict14.jpg"></img>


<p>Выставив все опции и нажав OK, начнется процесс восстановления.</p>
</Урок>