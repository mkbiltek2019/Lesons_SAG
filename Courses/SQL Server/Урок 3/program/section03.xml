<?xml version="1.0" encoding="windows-1251" ?>

<!DOCTYPE page [
<!ENTITY nbsp "&#160;">
<!ENTITY пробел "&#160;">
<!ENTITY shy "&#173;">
<!ENTITY перенос "&#173;">
]>

<?xml:stylesheet type="text/xsl" href="../common/layout.xsl" ?>

<Урок xmlns="x-schema:Schema.xml" название="Принципы создания многотабличной базы данных." 
предыдущий="section02.xml" следующий="section04.xml" copyright="© 2005 Вадим Волянский, Алексей Туманов.">

<h1 style="color:maroon">Принципы создания многотабличной базы данных.</h1>

<p>
Чтобы не создавать новую базу данных мы будем видоизменять структуру базы данных books, которую вы импортировали. Учитывая, что информация повторяется много раз в полях Izd, Themes и Categories, вынесем эту информацию в 3 отдельных таблицы.
</p>

<p>
В таблицу books, при помощи Enterprise manager, добавляем 3 поля : id_press, id_theme, id_category, также поле N нужно переименовать в Id и сделать первичным ключом, если оно таковым не является. Создаем таблицы для хранения издательств - Press, таблицу для тематик - Themes, таблицу для категорий - Categories. Поля с таблицы books нужно будет удалить только после экспортирования данных из нее.
</p>

<p>
У вас должны получиться следующие таблицы в базе данных Books. При изменении, например, типов данных, возможно, появится предупреждение о потере данных. Также возможна ошибка установки первичного ключа, если в этом поле есть повторяющиеся значения.
</p>

<table border="2" bordercolor="#082C63" >
<tr><td colspan="5" align="center" bgcolor="#5BFFB4">BOOKS</td></tr>
<tr><td>Id</td><td>int</td><td>4</td><td>Not Null</td><td>Identity - yes, Seed - 1, Increment - 1</td></tr>
<tr><td>Code</td><td>float</td><td>8</td><td>Nullable</td></tr>
<tr><td>New</td><td>bit</td><td>1</td><td>Not Null</td></tr>
<tr><td>Name</td><td>varchar</td><td>40</td><td>Nullable</td></tr>
<tr><td>Price</td><td>money</td><td>8</td><td>Nullable</td></tr>
<tr><td>Izd</td><td>varchar</td><td>40</td><td>Nullable</td></tr>
<tr><td>Pages</td><td>int</td><td>4</td><td>Nullable</td></tr>
<tr><td>Format</td><td>varchar</td><td>20</td><td>Nullable</td></tr>
<tr><td>Date</td><td>smalldatetime</td><td>4</td><td>Nullable</td></tr>
<tr><td>Pressrun</td><td>int</td><td>4</td><td>Nullable</td></tr>
<tr><td>Categories</td><td>varchar</td><td>40</td><td>Nullable</td></tr>
<tr><td>Themes</td><td>varchar</td><td>40</td><td>Nullable</td></tr>
<tr><td>id_press</td><td>int</td><td>4</td><td>Nullable</td></tr>
<tr><td>id_theme</td><td>int</td><td>4</td><td>Nullable</td></tr>
<tr><td>id_category</td><td>int</td><td>4</td><td>Nullable</td></tr>
</table>

<br/>

<p>
Вот как должна выглядеть Books в Enterprise manager.
</p>

<img src="img\pict4.jpg"></img>

<br/>

<table border="2" bordercolor="#082C63">
<tr><td colspan="5" align="center" bgcolor="#5BFFB4">Press</td></tr>
<tr><td>Id</td><td>int</td><td>4</td><td>Not Null</td><td>Identity - yes, Seed - 1, Increment - 1</td></tr>
<tr><td>Name</td><td>varchar</td><td>40</td><td>Nullable</td></tr>
</table>

<br/>

<img src="img\pict5.jpg"></img>

<table border="2" bordercolor="#082C63">
<tr><td colspan="5" align="center" bgcolor="#5BFFB4">Themes</td></tr>
<tr><td>Id</td><td>int</td><td>4</td><td>Not Null</td><td>Identity - yes, Seed - 1, Increment - 1</td></tr>
<tr><td>Name</td><td>varchar</td><td>40</td><td>Nullable</td></tr>
</table>

<br/>

<table border="2" bordercolor="#082C63">
<tr><td colspan="5" align="center" bgcolor="#5BFFB4">Categories</td></tr>
<tr><td>Id</td><td>int</td><td>4</td><td>Not Null</td><td>Identity - yes, Seed - 1, Increment - 1</td></tr>
<tr><td>Name</td><td>varchar</td><td>40</td><td>Nullable</td></tr>
</table>

<p>
Надеюсь, что проблем с созданием у вас не возникло. Теперь нужно эти таблицы заполнить. При этом, нужно использовать информацию с таблицы books.
</p>

<p>
Чтобы начать работу с копированием данных необходимо изучить еще одно ключевое слово.
</p>

<h2>Distinct</h2>

<p>
Иногда возникает необходимость показать значения столбца, исключив при показе повторяющиеся значения. Для этого перед именами (либо именем) поля указывается ключевое слово <b>Distinct</b>. Только вы должны помнить, что повторения убираются из столбца с максимальным кол-вом <b>неповторяющихся</b> значений.
</p>

<p>
Запрос <b>Select izd from books</b> выдаст в результате такую таблицу.
</p>

<img src="img\pict27.jpg"></img>

<p>
Если же вы хотите исключить повторения, тогда запрос будет выглядеть так:
</p>

<pre style="border:3px #FF0000 solid">
Select Distinct izd

From books
</pre>

<p>
И вы получите такой результат:
</p>

<img src="img\pict28.jpg"></img>

<p>
Результатом будут являться названия издательств, при этом повторяться они не будут. Но.
</p>

<p>
Пример 2. 
</p>

<pre style="border:3px #FF0000 solid">
Select Distinct name, izd

From books
</pre>

<p>
Теоретически должно быть два столбца: названия книг, без повторений и названия издательств, без повторений. Но книг без повторений около 800, а издательств без повторений около 60. Вывести несколько столбцов с разным кол-вом строк - невозможно. Поэтому записей в поле с издательствами будет столько же, сколько и в столбце с названиями книг. И, конечно же, названия издательств, при этом, будут повторяться. 
</p>

<img src="img\pict29.jpg"></img>

<h3 align='center'><font color="#1925AB">Импортирование данных из одной таблицы в другую.</font></h3>

<p>
Начнем с копирования данных из таблицы books в таблицы press. Сразу определим, что нужно скопировать: столбец <b><i>Izd</i></b> таблицы <b>Books</b> должен быть скопирован в столбец <b><i>Name</i></b> таблицы <b>Press</b> без повторений.
</p>

<p>
Открываем Enterprise manager, выбираем пункт меню <i>Все задачи -> Export Data...</i> таблицы Books.
</p>

<img src="img\pict6.jpg"></img>

<p>
Появляется менеджер импортирования и экспортирования данных.
</p>

<img src="img\pict7.jpg"></img>

<p>
В этом окне определяется ресурс, откуда будет производиться импортирование информации. Конечно же, в этот раз это база данных Books.
</p>

<p>
В следующем окне необходимо указать базу данных, в которую будет производиться импортирование данных. Это наша же база данных Books.
</p>

<img src="img\pict8.jpg"></img>

<img src="img\pict9.jpg"></img>

<p>
Далее необходимо определить тип копируемой информации. Выбираем Use a query to specify the data to transfer. Т.е. использовать запрос для определения требуемой информации. Учитывая, что мы копируем издательства, запрос следует указать такой:
</p>

<pre>
Select distinct izd

from books

where izd is not null
</pre>

<img src="img\pict10.jpg"></img>

<p>
Нажимаем Далее.
</p>

<img src="img\pict11.jpg"></img>

<p>
В появившемся окне нужно конкретно указать куда производить вставку информации. Для этого нужно нажать на выпадающий список Destination и выбрать требуемую таблицу той базы данных, которую указали во втором окне утилиты Импорта/Экспорта данных Chose a destination. В нашем случае это таблица Press. После этого нужно нажать на <b>...</b> столбца Transform.
</p>

<img src="img\pict12.jpg"></img>

<p>
Здесь необходимо:
	<ol>
	<li>Снять галочку Enable identity insert, определив тем самым, что данные в столбец первичного ключа будут добавляться автоматически.</li>
	<li>В поле Source определить то поле, в которое нужно вставить данные (оно должно быть не &lt;ignore&gt;). Все ненужные, при этом, устанавливаем в &lt;ignore&gt;</li>
	</ol>
</p>

<img src="img\pict13.jpg"></img>

<p>
После этого нажимаем Ok -> Далее -> Готово. После этого данные должны быть скопированы в новую таблицу.
</p>

<p>
Те же шаги проделываем для таблиц Categories и Themes. Заодно закрепляем процедуру экспортирования.
</p>

<p>
Осталось дело за малым. Нужно заполнить нужные значения в поля id_press, id_category, id_theme. Для этого необходимо написать запрос.
</p>

<pre>
Update books

set books.id_press=press.id

from books, press 

where books.izd=press.name
</pre>

<p>
Здесь указывается, что производится обновление таблицы books <i>(Update books)</i>, при этом значения в поле books.id_press берутся из поля press.id, после чего указывается конкретно какое значение брать. Для каждой строки - это совпадение имен издательств (books.izd=press.name). Вы должны понимать на логическом уровне, что в определенной строке должен быть тот код, под которым указанное издательство находится в другой таблице.
</p>

<p>
Такой вариант прописывания связей устарел. Более полное обоснование использования связей и их применения описывается в следующей главе. Пока вы должны понимать, что обращение к столбцу можно производить указав <b><i>Имя_таблицы.Имя_поля</i></b>.
</p>

<p>
Такого же рода пишем запросы для Тематик и Категорий. После этого столбцы с названиями категорий, тематик и издательств можно удалять из таблицы books. Для этого выбираем в контекстном меню требуемого поля пункт меню Delete.
</p>

<img src="img\pict14.jpg"></img>

<p>
После проделанной работы получилась многотабличная база данных, что от нас и требовалось. Но, представьте, вы пришли в компанию и вам нужно разобраться с базой данных, в которой 40 таблиц, причем все друг с другом связаны и при этом как - никто не знает. Для упрощения служит построение диаграммы базы данных.
</p>

<p>
Для этого в Enterprise manager нужно выбрать в контекстном меню пункта Diagrams требуемой базы данных, New Database Diagram... .
</p>

<img src="img\pict15.jpg"></img>

<p>
Появляется мастер создания диаграмм.
</p>

<img src="img\pict16.jpg"></img>

<p>
С левой колонки перемещаем требуемые таблицы в правую, при помощи кнопки Add. Remove перемещает таблицы из левой колонки в правую. Она используется, если вы случайно перетянули не нужную таблицу.
</p>

<p>
После этого нажимаем  Далее -> Готово. На экране появятся выбранные таблицы.
</p>

<img src="img\pict17.jpg"></img>

<p>
Теперь нужно перетянуть первичный ключ одной таблицы (например Press) на внешний ключ другой (в нашем случае Books). 
</p>

<img src="img\pict18.jpg"></img>

<p>
Появится окно - Определение связей.
</p>

<img src="img\pict19.jpg"></img>

<p>
В первом поле Relationship name указывается имя для создаваемой связи. Поле Primary key table - определяет таблицу, в которой первичный ключ, а поле Foreign key table - определяет таблицу, в которой находится внешний ключ. Если поля перетягивались правильно, то имена полей указываются автоматически. Если же нажать на другое поле при перетягивании, то в этом окошке вы можете это поменять. Для этого служит выпадающий список, раскрывается который при нажатии на стрелочку рядом с именем поля.
</p>

<p>
 Ниже указаны настройки связи.
</p>

<ol>
	<li><b>Check existing data on creation</b> - определяет, что при создании текущей связи будет произведена проверка правильности, и наличия введенных данных в каждое из указанных полей.</li>
	<li><b>Enforce relationship for replication</b> - определяет, что данные связанных полей будут проверены, при проведении репликаций.</li>
	<li><b>Enforce relationship for INSERTs and UPDATEs</b> - определяет, что при добавлении, изменении либо удалении будет произведена проверка данных. Например, если значение первичного ключа присутствует в поле внешнего ключа, то обновить либо удалить эту запись в таблице, чей первичный ключ вынесен, нельзя.
	<ul>
		<li><b><i>Cascade Update Related Fields</i></b> - определяет, что при обновлении значения первичного ключа связанной таблицы, значения внешнего ключа, которые совпадают, будут автоматически обновлены также.</li>
		<li><b><i>Cascade Delete Related Records</i></b> - определяет, что при удалении строки с таблицы, у которой вынесен первичный ключ, удаляться будут также строки основной таблицы, в которых удаляемое значение первичного и внешнего ключей совпадают.</li>
	</ul>
	</li>
</ol>

<p>
Такие же связи необходимо указать и для двух оставшихся таблиц. После этого закрываете мастер создания диаграмм, указывая для него имя.
</p>

</Урок>